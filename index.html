<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finance Tracker Master</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <style>
        :root { --in: #16a34a; --out: #dc2626; --accent: #2563eb; --bg: #f8fafc; --text: #1e293b; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 15px; margin: 0; padding-top: 75px; }
        .search-header { position: fixed; top: 0; left: 0; right: 0; background: white; padding: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 100; }
        .card { background: white; padding: 18px; border-radius: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 15px; }
        label { display: block; font-size: 10px; color: #64748b; text-transform: uppercase; font-weight: 700; margin-bottom: 4px; }
        select, input { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 16px; box-sizing: border-box; }
        .tab-group { display: flex; background: #f1f5f9; padding: 4px; border-radius: 10px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 10px; border: none; border-radius: 7px; cursor: pointer; font-weight: 600; color: #64748b; }
        .tab-btn.active-in { background: var(--in); color: white; }
        .tab-btn.active-out { background: var(--out); color: white; }
        .btn-process { width: 100%; padding: 15px; background: var(--accent); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 700; cursor: pointer; }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .stat-item { background: #fff; border: 1px solid #e2e8f0; padding: 10px; border-radius: 10px; text-align: center; }
        .stat-item small { font-size: 9px; color: #64748b; display: block; text-transform: uppercase; }
        .stat-item strong { font-size: 14px; color: var(--accent); }
        
        .group-header { background: #f1f5f9; padding: 8px 12px; margin-top: 15px; border-radius: 6px; font-size: 11px; font-weight: bold; color: var(--accent); display: flex; justify-content: space-between; }
        .mini-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .mini-table td { padding: 12px 5px; border-bottom: 1px solid #f1f5f9; }
        .chip { display: inline-block; background: #e2e8f0; padding: 4px 8px; border-radius: 15px; font-size: 11px; margin: 2px; }
        
        #annualSummaryTable { width: 100%; font-size: 12px; margin-top: 10px; border-top: 1px solid #eee; }
        #annualSummaryTable td { padding: 5px 0; }
    </style>
</head>
<body>

<div class="search-header">
    <input type="text" id="searchInput" placeholder="üîç Search Suppliers..." onkeyup="renderApp()">
</div>

<div class="card" style="background: #eff6ff; border: 1px solid #dbeafe;">
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <label id="dashTitle" style="margin:0;">PERFORMANCE</label>
        <select id="viewType" onchange="renderApp()" style="width:auto; padding:4px; font-size:10px; height:auto; margin:0;">
            <option value="month">Current Month</option>
            <option value="year">Full Year View</option>
        </select>
    </div>
    <div class="stat-grid">
        <div class="stat-item"><small id="leftStatLabel">Avg Spend</small><strong id="avgSpend">R0</strong></div>
        <div class="stat-item"><small id="rightStatLabel">Savings Mo</small><strong id="bestMonth">None</strong></div>
        <div class="stat-item"><small id="inLabel">Month In</small><strong id="statIn" style="color:var(--in)">R0</strong></div>
        <div class="stat-item"><small id="outLabel">Month Out</small><strong id="statOut" style="color:var(--out)">R0</strong></div>
    </div>
    <div id="annualBreakdown" style="display:none; margin-top:10px;">
        <label>Yearly Spending by Supplier</label>
        <table id="annualSummaryTable"></table>
    </div>
</div>

<div class="card">
    <div class="tab-group">
        <button id="tabIn" class="tab-btn" onclick="setMode('in')">Money In</button>
        <button id="tabOut" class="tab-btn active-out" onclick="setMode('out')">Money Out</button>
    </div>

    <div style="display:flex; gap:8px; margin-bottom:12px;">
        <div style="flex:1"><label>Year</label><select id="entryYear" onchange="renderApp()"></select></div>
        <div style="flex:1.5"><label>Month</label><select id="entryMonth" onchange="renderApp()"></select></div>
        <div style="flex:1"><label>Day</label><select id="entryDay"></select></div>
    </div>

    <div class="card" id="scanField" style="padding:10px; border: 1px dashed #cbd5e1; box-shadow:none; margin-bottom:12px;">
        <label>Scan Slip (OCR)</label>
        <input type="file" id="cameraInput" accept="image/*">
        <div id="ocrStatus" style="font-size:10px; font-weight:bold; color:var(--accent); margin-top:5px;">Ready</div>
    </div>

    <div style="margin-bottom:12px;">
        <label>Amount (R)</label>
        <input type="number" id="entryAmount" inputmode="decimal" placeholder="0.00">
    </div>
    
    <div id="outFields" style="display:flex; gap:8px; margin-bottom:12px;">
        <div style="flex:1"><label>Supplier</label><select id="entrySupplier" onchange="saveSelections()"></select></div>
        <div style="flex:1"><label>Category</label><select id="entryCategory" onchange="saveSelections()"></select></div>
    </div>
    
    <button class="btn-process" onclick="processEntry()">SAVE TRANSACTION</button>
</div>

<div id="historyContainer"></div>

<div class="card" style="margin-top:30px; border-top: 4px solid var(--accent);">
    <label>Manage Lists</label>
    <div style="display:flex; gap:5px; margin-bottom:15px;">
        <input type="text" id="newLabelName" placeholder="New name..." style="flex:2; padding:8px;">
        <button onclick="addListItem('sups')" style="flex:1; background:var(--accent); color:white; border:none; border-radius:8px; font-size:10px;">+ SHOP</button>
        <button onclick="addListItem('cats')" style="flex:1; background:var(--accent); color:white; border:none; border-radius:8px; font-size:10px;">+ CAT</button>
    </div>
    <div id="manageSups"></div><br>
    <div id="manageCats"></div>
    <hr style="border:0; border-top:1px solid #e2e8f0; margin:20px 0;">
    <button onclick="exportCSV()" style="width:100%; background:#1e293b; color:white; padding:12px; border-radius:10px; border:none; font-weight:bold;">üì• DOWNLOAD EXCEL (CSV)</button>
</div>

<script>
    let mode = 'out';
    let records = JSON.parse(localStorage.getItem('f_data')) || [];
    let cats = JSON.parse(localStorage.getItem('f_cats')) || ['Groceries', 'Petrol', 'Rent', 'Salary'];
    let sups = JSON.parse(localStorage.getItem('f_sups')) || ['Checkers', 'Woolworths', 'Shell', 'Employer'];
    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

    function init() {
        const yearSel = document.getElementById('entryYear');
        for(let i = 2024; i <= 2027; i++) yearSel.innerHTML += `<option value="${i}">${i}</option>`;
        yearSel.value = new Date().getFullYear();
        document.getElementById('entryMonth').innerHTML = months.map((m,i)=>`<option value="${i}">${m}</option>`).join('');
        document.getElementById('entryMonth').value = new Date().getMonth();
        document.getElementById('entryDay').innerHTML = Array.from({length:31},(_,i)=>`<option value="${i+1}">${i+1}</option>`).join('');
        document.getElementById('entryDay').value = new Date().getDate();
        renderApp();
        loadSelections(); 
    }

    function setMode(m) {
        mode = m;
        document.getElementById('tabIn').className = m==='in' ? 'tab-btn active-in' : 'tab-btn';
        document.getElementById('tabOut').className = m==='out' ? 'tab-btn active-out' : 'tab-btn';
        document.getElementById('outFields').style.opacity = m==='out' ? '1' : '0.3';
        document.getElementById('scanField').style.display = m==='out' ? 'block' : 'none';
    }

    function saveSelections() {
        localStorage.setItem('sticky_sup', document.getElementById('entrySupplier').value);
        localStorage.setItem('sticky_cat', document.getElementById('entryCategory').value);
    }

    function loadSelections() {
        if(localStorage.getItem('sticky_sup')) document.getElementById('entrySupplier').value = localStorage.getItem('sticky_sup');
        if(localStorage.getItem('sticky_cat')) document.getElementById('entryCategory').value = localStorage.getItem('sticky_cat');
    }

    function processEntry() {
        const amt = parseFloat(document.getElementById('entryAmount').value);
        if(!amt) return;
        const sup = mode === 'out' ? document.getElementById('entrySupplier').value : 'Income';
        const cat = mode === 'out' ? document.getElementById('entryCategory').value : 'Salary';
        records.push({
            id: Date.now(), type: mode,
            year: parseInt(document.getElementById('entryYear').value),
            month: parseInt(document.getElementById('entryMonth').value),
            day: parseInt(document.getElementById('entryDay').value),
            amount: amt, supplier: sup, category: cat
        });
        localStorage.setItem('f_data', JSON.stringify(records));
        saveSelections();
        document.getElementById('entryAmount').value = '';
        renderApp();
    }

    function renderApp() {
        document.getElementById('entryCategory').innerHTML = cats.map(c=>`<option>${c}</option>`).join('');
        document.getElementById('entrySupplier').innerHTML = sups.map(s=>`<option>${s}</option>`).join('');
        loadSelections();

        document.getElementById('manageSups').innerHTML = sups.map((s,i)=>`<span class="chip">${s}<span onclick="removeListItem('sups',${i})">√ó</span></span>`).join('');
        document.getElementById('manageCats').innerHTML = cats.map((c,i)=>`<span class="chip">${c}<span onclick="removeListItem('cats',${i})">√ó</span></span>`).join('');

        const selY = parseInt(document.getElementById('entryYear').value);
        const selM = parseInt(document.getElementById('entryMonth').value);
        const viewType = document.getElementById('viewType').value;

        const yearRecords = records.filter(r => r.year === selY);
        const yearIn = yearRecords.filter(r => r.type === 'in').reduce((s,r) => s + r.amount, 0);
        const yearOut = yearRecords.filter(r => r.type === 'out').reduce((s,r) => s + r.amount, 0);
        
        // Annual stats for labels
        let monthTotals = Array(12).fill(0).map(() => ({ in: 0, out: 0 }));
        yearRecords.forEach(r => {
            if(r.type === 'in') monthTotals[r.month].in += r.amount;
            else monthTotals[r.month].out += r.amount;
        });
        const activeMonths = monthTotals.filter(m => m.in > 0 || m.out > 0).length || 1;
        let bestVal = -Infinity; let bestMo = "None";
        monthTotals.forEach((m, i) => {
            let surplus = m.in - m.out;
            if((m.in > 0 || m.out > 0) && surplus > bestVal) { bestVal = surplus; bestMo = months[i]; }
        });

        if(viewType === 'year') {
            document.getElementById('dashTitle').innerText = `${selY} ANNUAL SUMMARY`;
            document.getElementById('inLabel').innerText = "Year In";
            document.getElementById('outLabel').innerText = "Year Out";
            document.getElementById('statIn').innerText = `R${yearIn.toFixed(0)}`;
            document.getElementById('statOut').innerText = `R${yearOut.toFixed(0)}`;
            document.getElementById('annualBreakdown').style.display = 'block';
            
            // Generate per-supplier table
            let supMap = {};
            yearRecords.filter(r => r.type === 'out').forEach(r => {
                supMap[r.supplier] = (supMap[r.supplier] || 0) + r.amount;
            });
            let sortedSups = Object.entries(supMap).sort((a,b) => b[1] - a[1]);
            document.getElementById('annualSummaryTable').innerHTML = sortedSups.map(([name, val]) => `
                <tr><td>${name}</td><td style="text-align:right; font-weight:bold;">R${val.toFixed(2)}</td></tr>
            `).join('');
        } else {
            document.getElementById('dashTitle').innerText = `${months[selM]} ${selY} PERFORMANCE`;
            document.getElementById('inLabel').innerText = "Month In";
            document.getElementById('outLabel').innerText = "Month Out";
            document.getElementById('annualBreakdown').style.display = 'none';
            const filtered = yearRecords.filter(r => r.month === selM);
            document.getElementById('statIn').innerText = `R${filtered.filter(r=>r.type==='in').reduce((s,r)=>s+r.amount,0).toFixed(0)}`;
            document.getElementById('statOut').innerText = `R${filtered.filter(r=>r.type==='out').reduce((s,r)=>s+r.amount,0).toFixed(0)}`;
        }

        document.getElementById('avgSpend').innerText = `R${(yearOut / activeMonths).toFixed(0)}`;
        document.getElementById('bestMonth').innerText = bestMo;

        // Render History (Always Monthly)
        const historyFiltered = yearRecords.filter(r => r.month === selM);
        const container = document.getElementById('historyContainer');
        container.innerHTML = '';
        let sorted = historyFiltered.sort((a,b) => a.supplier.localeCompare(b.supplier) || a.day - b.day);
        const q = document.getElementById('searchInput').value.toLowerCase();
        if(q) sorted = sorted.filter(r => r.supplier.toLowerCase().includes(q));

        let currentSup = ""; let supTotal = 0; let buffer = "";
        sorted.forEach((r, i) => {
            if(r.supplier !== currentSup) {
                if(currentSup !== "") flush(currentSup, supTotal, buffer);
                currentSup = r.supplier; supTotal = 0; buffer = "";
            }
            supTotal += r.amount;
            buffer += `<tr><td>${r.day} ${months[r.month]}</td><td>${r.category}</td><td style="text-align:right; font-weight:bold; color:${r.type==='in'?'var(--in)':'var(--text)'}">R${r.amount.toFixed(2)}</td><td style="text-align:right" onclick="deleteRec(${r.id})">üóëÔ∏è</td></tr>`;
            if(i === sorted.length - 1) flush(currentSup, supTotal, buffer);
        });
    }

    function flush(name, total, html) {
        document.getElementById('historyContainer').innerHTML += `<div class="group-header"><span>${name.toUpperCase()}</span><span>R${total.toFixed(2)}</span></div><table class="mini-table">${html}</table>`;
    }

    function addListItem(type) {
        const val = document.getElementById('newLabelName').value.trim();
        if(!val) return;
        if(type==='cats') cats.push(val); else sups.push(val);
        localStorage.setItem('f_'+type, JSON.stringify(type==='cats'?cats:sups));
        document.getElementById('newLabelName').value = ''; renderApp();
    }

    function removeListItem(type, i) {
        if(confirm("Remove?")) {
            if(type==='cats') cats.splice(i,1); else sups.splice(i,1);
            localStorage.setItem('f_'+type, JSON.stringify(type==='cats'?cats:sups));
            renderApp();
        }
    }

    document.getElementById('cameraInput').onchange = async (e) => {
        const file = e.target.files[0]; if(!file) return;
        const status = document.getElementById('ocrStatus');
        status.innerText = "‚åõ Scanning...";
        const worker = await Tesseract.createWorker();
        try {
            await worker.loadLanguage('eng'); await worker.initialize('eng');
            const { data: { text } } = await worker.recognize(file);
            const m = text.match(/\d+[\.,]\d{2}/g);
            if(m) document.getElementById('entryAmount').value = Math.max(...m.map(n=>parseFloat(n.replace(',','.'))));
            sups.forEach(s => { if(text.toUpperCase().includes(s.toUpperCase())) { document.getElementById('entrySupplier').value = s; saveSelections(); } });
            status.innerText = "‚úÖ Done"; await worker.terminate();
        } catch (err) { status.innerText = "‚ùå Failed"; await worker.terminate(); }
    };

    function exportCSV() {
        let csv = "Date,Type,Supplier,Category,Amount\n";
        records.forEach(r => csv += `${r.day} ${months[r.month]} ${r.year},${r.type},${r.supplier},${r.category},${r.amount}\n`);
        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `Finance_Backup_${new Date().getFullYear()}.csv`; a.click();
    }

    function deleteRec(id) { if(confirm("Delete?")) { records = records.filter(r=>r.id!==id); localStorage.setItem('f_data',JSON.stringify(records)); renderApp(); } }

    init();
</script>
</body>
</html>
